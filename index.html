<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Modern Snake — Deluxe</title>
<style>
  :root{
    --bg-1: #0f1724;
    --bg-2: #071426;
    --accent: #00e6a8;
    --accent-2: #7b61ff;
    --muted: rgba(255,255,255,0.8);
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e6eef8;-webkit-font-smoothing:antialiased}
  .wrap{display:flex;flex-direction:column;height:100vh;gap:12px;padding:12px;box-sizing:border-box}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(123,97,255,0.12);font-weight:700;font-size:18px;color:#021019}
  .stats{display:flex;gap:8px;align-items:center}
  .chip{background:var(--glass);padding:8px 12px;border-radius:12px;font-size:14px;color:var(--muted);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.03)}
  .stage{position:relative;flex:1;display:flex;align-items:center;justify-content:center;min-height:260px}
  canvas{border-radius:14px;box-shadow:0 20px 50px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);touch-action:none;max-width:100%;width:100%;height:auto;max-height: calc(100vh - 240px)}
  .hud{position:absolute;left:18px;top:18px;display:flex;gap:10px;align-items:center}
  .btn{border:none;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));color:var(--muted);font-weight:600;cursor:pointer;border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px)}
  .btn.primary{background: linear-gradient(90deg,var(--accent),var(--accent-2));color:#051018;box-shadow:0 8px 30px rgba(123,97,255,0.12)}
  .overlay-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .msg{pointer-events:auto;background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:18px 22px;border-radius:14px;text-align:center;min-width:240px;border:1px solid rgba(255,255,255,0.03)}
  .controls{display:flex;gap:12px;align-items:center;justify-content:center;width:100%;padding:8px 0}
  .touch-pad{position:absolute;right:16px;bottom:16px;display:grid;grid-template-columns: repeat(3,64px);grid-template-rows: repeat(2,64px);gap:10px;z-index:40;user-select:none}
  .touch-pad button{width:64px;height:64px;border-radius:50%;border:none;background: rgba(255,255,255,0.03);color:var(--muted);font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(3,8,20,0.5);backdrop-filter: blur(6px)}
  .touch-pad .space{visibility:hidden}
  @media (max-width:520px){.touch-pad{grid-template-columns: repeat(3,56px);grid-template-rows: repeat(2,56px)}.touch-pad button{width:56px;height:56px;font-size:20px}.logo{width:40px;height:40px;font-size:16px;border-radius:9px}}
  .select, .label { font-size:13px; color:var(--muted) }
  .controls-row { display:flex; gap:8px; align-items:center; }
  .switch { display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted) }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <div style="font-weight:700">Modern Snake — Deluxe</div>
        <div style="font-size:12px;color:var(--muted)">Ses, Wrap, Tema & Zorluk</div>
      </div>
    </div>

    <div class="stats">
      <div class="chip" id="scoreChip">Puan: 0</div>
      <div class="chip" id="highChip">En Yüksek: 0</div>
      <button class="btn" id="pauseBtn">Duraklat</button>
      <button class="btn primary" id="restartBtn">Yeniden Başla</button>
    </div>
  </div>

  <div class="stage">
    <canvas id="game"></canvas>

    <div class="overlay-center" id="overlay"></div>

    <div style="position:absolute;right:18px;top:18px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
      <div class="controls-row">
        <label class="label">Tema:</label>
        <select id="themeSelect" class="select">
          <option value="night">Gece</option>
          <option value="neon">Neon</option>
          <option value="pastel">Pastel</option>
        </select>
      </div>
      <div class="controls-row">
        <label class="label">Zorluk:</label>
        <select id="diffSelect" class="select">
          <option value="easy">Kolay</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Zor</option>
        </select>
      </div>
      <div class="switch">
        <input type="checkbox" id="wrapToggle" checked />
        <label for="wrapToggle" class="label">Ekran Sarma (Wrap)</label>
      </div>
    </div>

    <div class="touch-pad" id="touchPad" aria-hidden="false">
      <button data-dir="up" title="Yukarı">▲</button>
      <button class="space" aria-hidden="true"></button>
      <button data-dir="left" title="Sol">◄</button>
      <button data-dir="down" title="Aşağı">▼</button>
      <button class="space" aria-hidden="true"></button>
      <button data-dir="right" title="Sağ">►</button>
    </div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-size:13px;color:var(--muted)">Swipe veya ok tuşları ile yönlendir. Ses & ayarlar sağ üstte.</div>
    <div style="font-size:13px;color:var(--muted)">v1.1 — local</div>
  </div>
</div>

<script>
(() => {
  // DOM
  const canvas = document.getElementById('game'), ctx = canvas.getContext('2d', { alpha: false });
  const scoreChip = document.getElementById('scoreChip'), highChip = document.getElementById('highChip');
  const overlay = document.getElementById('overlay'), pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn'), touchPad = document.getElementById('touchPad');
  const themeSelect = document.getElementById('themeSelect'), diffSelect = document.getElementById('diffSelect');
  const wrapToggle = document.getElementById('wrapToggle');

  // Audio via WebAudio (no external files)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  function ensureAudio() { if (!audioCtx) audioCtx = new AudioCtx(); }

  function playClick() {
    try {
      ensureAudio();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = 800;
      g.gain.value = 0.06;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.05);
    } catch(e) {}
  }
  function playPop() {
    try {
      ensureAudio();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.setValueAtTime(450, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(220, audioCtx.currentTime + 0.12);
      g.gain.setValueAtTime(0.08, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.13);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.14);
    } catch(e) {}
  }
  function playFail() {
    try {
      ensureAudio();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = 'sawtooth'; o.frequency.setValueAtTime(160, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.35);
      g.gain.setValueAtTime(0.12, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.45);
    } catch(e) {}
  }

  // Default config and themes
  const baseConfig = {
    cols: 24, rows: 24, cellMin: 12, initialLength: 4
  };
  const themes = {
    night: {
      bg1: '#0f1724', bg2: '#071426',
      snakeA: '#7b61ff', snakeB: '#00e6a8',
      apple: ['#ff7a64','#ff5040']
    },
    neon: {
      bg1: '#020617', bg2: '#06152a',
      snakeA: '#00ffb3', snakeB: '#ff00fb',
      apple: ['#fff000','#ff5500']
    },
    pastel: {
      bg1: '#f6f8ff', bg2: '#eaf1ff',
      snakeA: '#9bb4ff', snakeB: '#a6ffc8',
      apple: ['#ff9bb3','#ff6f91']
    }
  };

  // Difficulty presets
  const difficulties = {
    easy: { baseSpeed: 5, speedInc: 0.18, initialLength: 5 },
    normal: { baseSpeed: 8, speedInc: 0.3, initialLength: 4 },
    hard: { baseSpeed: 12, speedInc: 0.45, initialLength: 3 }
  };

  // State
  let config = { ...baseConfig };
  let grid = { ...config, cell: 20, width: 0, height: 0 };
  let snake = [], dir = {x:1,y:0}, nextDir = null, apple = null;
  let score = 0, high = parseInt(localStorage.getItem('modernSnakeHigh') || '0', 10);
  let speed = difficulties.normal.baseSpeed, speedInc = difficulties.normal.speedInc, moveInterval = 1000 / speed;
  let running = true, lastTick = 0, accumulator = 0, gameOver = false;
  let deviceRatio = window.devicePixelRatio || 1;
  let wrapEnabled = true;
  let currentTheme = 'night';

  highChip.textContent = 'En Yüksek: ' + high;

  // Resize canvas
  function resizeCanvas() {
    const availableW = Math.max(300, window.innerWidth - 48);
    const availableH = Math.max(300, window.innerHeight - 260);
    const useW = Math.min(availableW, Math.max(availableH, availableW));
    const useH = Math.min(availableH, useW * 1.2);
    let cell = Math.floor(Math.min(useW / config.cols, useH / config.rows));
    cell = Math.max(cell, config.cellMin);
    grid.cell = cell; grid.cols = config.cols; grid.rows = config.rows;
    grid.width = grid.cell * grid.cols; grid.height = grid.cell * grid.rows;
    deviceRatio = window.devicePixelRatio || 1;
    canvas.style.width = grid.width + 'px'; canvas.style.height = grid.height + 'px';
    canvas.width = Math.floor(grid.width * deviceRatio); canvas.height = Math.floor(grid.height * deviceRatio);
    ctx.setTransform(deviceRatio,0,0,deviceRatio,0,0);
    draw();
  }
  window.addEventListener('resize', resizeCanvas);

  // Helpers
  function rndInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function circle(c,x,y,r){ c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.closePath(); }
  function roundRect(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }
  function lerpColor(a,b,t){
    const pa = parseInt(a.slice(1),16), pb = parseInt(b.slice(1),16);
    const ar=(pa>>16)&255,ag=(pa>>8)&255,ab=pa&255, br=(pb>>16)&255,bg=(pb>>8)&255,bb=pb&255;
    const rr=Math.round(ar+(br-ar)*t), rg=Math.round(ag+(bg-ag)*t), rb=Math.round(ab+(bb-ab)*t);
    return `rgb(${rr},${rg},${rb})`;
  }

  function placeApple(){
    let attempts=0;
    while(attempts<2000){
      const x=rndInt(0,grid.cols-1), y=rndInt(0,grid.rows-1);
      if(!snake.some(p=>p.x===x&&p.y===y)){ apple={x,y}; return; }
      attempts++;
    }
    apple={x:0,y:0};
  }

  function applyTheme(name){
    currentTheme = name;
    const t = themes[name];
    document.documentElement.style.setProperty('--bg-1', t.bg1);
    document.documentElement.style.setProperty('--bg-2', t.bg2);
    document.documentElement.style.setProperty('--accent', t.snakeA);
    document.documentElement.style.setProperty('--accent-2', t.snakeB);
    draw();
  }

  function applyDifficulty(name){
    const d = difficulties[name];
    speed = d.baseSpeed; speedInc = d.speedInc; config.initialLength = d.initialLength;
    moveInterval = 1000 / speed;
    // restart with new difficulty (preserves high score)
    resetGame();
    startLoop();
  }

  // Reset
  function resetGame(){
    snake=[]; const sx=Math.floor(grid.cols/2), sy=Math.floor(grid.rows/2);
    for(let i=0;i<config.initialLength;i++){ snake.push({x: sx - i, y: sy}); }
    dir={x:1,y:0}; nextDir=null; score=0; moveInterval = 1000 / speed; running=true; gameOver=false; placeApple();
    scoreChip.textContent = 'Puan: ' + score; updateOverlay('');
  }

  // Drawing
  function drawGrid(){
    const c=ctx, w=grid.width, h=grid.height, s=grid.cell;
    c.clearRect(0,0,w,h);
    const t = themes[currentTheme];
    const g = c.createLinearGradient(0,0,0,h);
    g.addColorStop(0, hexToRgba(t.bg1, 0.9));
    g.addColorStop(1, hexToRgba(t.bg2, 0.95));
    c.fillStyle = g; roundRect(c,0,0,w,h,12); c.fill();
    c.strokeStyle = 'rgba(255,255,255,0.02)'; c.lineWidth = 1;
    for(let x=0;x<=w;x+=s){ c.beginPath(); c.moveTo(x+0.5,0); c.lineTo(x+0.5,h); c.stroke(); }
    for(let y=0;y<=h;y+=s){ c.beginPath(); c.moveTo(0,y+0.5); c.lineTo(w,y+0.5); c.stroke(); }
  }
  function drawApple(){
    if(!apple) return;
    const s = grid.cell, x = apple.x*s, y = apple.y*s;
    const cx = x + s/2, cy = y + s/2, r = s*0.38;
    const [c1,c2] = themes[currentTheme].apple;
    const g = ctx.createRadialGradient(cx,cy,r*0.1,cx,cy,r*1.2);
    g.addColorStop(0, c1); g.addColorStop(1, hexToRgba(c2,0.12));
    ctx.fillStyle = g; circle(ctx, cx, cy, r); ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; circle(ctx, cx - r*0.35, cy - r*0.35, r*0.12); ctx.fill();
  }
  function drawSnake(){
    if(!snake.length) return;
    const s = grid.cell;
    for(let i=snake.length-1;i>=0;i--){
      const p=snake[i], px=p.x*s, py=p.y*s;
      const t = 1 - (i / snake.length);
      const color = lerpColor(themes[currentTheme].snakeA, themes[currentTheme].snakeB, t);
      roundRect(ctx, px+2, py+2, s-4, s-4, 6);
      ctx.fillStyle = color; ctx.fill();
    }
    // head highlight
    const head = snake[0];
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    circle(ctx, head.x*s + s/2 - s*0.08, head.y*s + s/2 - s*0.18, s*0.12); ctx.fill();
  }
  function drawGlow(){
    const g = ctx.createRadialGradient(0,0,20, grid.width*0.6, grid.height*0.4, Math.max(grid.width,grid.height));
    g.addColorStop(0, hexToRgba(themes[currentTheme].snakeB, 0.06));
    g.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = g; ctx.fillRect(0,0,grid.width,grid.height);
  }
  function draw(){ drawGrid(); drawApple(); drawSnake(); drawGlow(); }

  // Game logic with wrap option
  function step(){
    if(gameOver || !running) return;
    if(nextDir){ if(!(nextDir.x === -dir.x && nextDir.y === -dir.y)) dir = nextDir; nextDir = null; }
    let nx = snake[0].x + dir.x, ny = snake[0].y + dir.y;
    if(wrapEnabled){
      if(nx < 0) nx = grid.cols - 1;
      if(nx >= grid.cols) nx = 0;
      if(ny < 0) ny = grid.rows - 1;
      if(ny >= grid.rows) ny = 0;
    } else {
      if(nx < 0 || nx >= grid.cols || ny < 0 || ny >= grid.rows){ endGame(); return; }
    }
    const head = { x: nx, y: ny };
    if(snake.some(p=>p.x===head.x&&p.y===head.y)){ endGame(); return; }
    snake.unshift(head);
    if(apple && head.x===apple.x && head.y===apple.y){
      score += 10; playPop();
      speed = Math.min(40, speed + speedInc);
      moveInterval = 1000 / speed; placeApple();
      scoreChip.textContent = 'Puan: ' + score;
      if(score > high){ high = score; localStorage.setItem('modernSnakeHigh', String(high)); highChip.textContent = 'En Yüksek: ' + high; }
    } else {
      snake.pop();
    }
  }

  function endGame(){
    gameOver = true; running = false; playFail();
    updateOverlay(`<div class="msg"><h3>Oyun Bitti</h3><p>Puanın: ${score}</p><div style="display:flex;gap:8px;justify-content:center;margin-top:10px;"><button class="btn" id="overlayMenu">Menü</button><button class="btn primary" id="overlayRestart">Tekrar Oyna</button></div></div>`);
    setTimeout(()=>{ const r=document.getElementById('overlayRestart'); if(r) r.addEventListener('click', ()=>{ resetGame(); startLoop(); updateOverlay(''); }); const m=document.getElementById('overlayMenu'); if(m) m.addEventListener('click', ()=>{ updateOverlay(''); }); },10);
  }
  function updateOverlay(html){ overlay.innerHTML = html || ''; }

  // Loop
  function loop(ts){
    if(!lastTick) lastTick = ts;
    const delta = ts - lastTick; lastTick = ts; accumulator += delta;
    while(accumulator >= moveInterval){
      step(); accumulator -= moveInterval;
    }
    draw();
    if(!gameOver && running) requestAnimationFrame(loop);
  }
  function startLoop(){ lastTick = 0; accumulator = 0; if(!gameOver) requestAnimationFrame(loop); running = true; }

  // Input: keyboard
  window.addEventListener('keydown', (e) => {
    if(['ArrowUp','w'].includes(e.key)) setDir({x:0,y:-1});
    if(['ArrowDown','s'].includes(e.key)) setDir({x:0,y:1});
    if(['ArrowLeft','a'].includes(e.key)) setDir({x:-1,y:0});
    if(['ArrowRight','d'].includes(e.key)) setDir({x:1,y:0});
    if(e.key === ' ' || e.key === 'Escape'){ togglePause(); }
  });

  function setDir(d){
    if(d.x === -dir.x && d.y === -dir.y) return;
    nextDir = d;
  }

  // Touch swipe
  let touchStart = null, touchId = null;
  const swipeThreshold = 20;
  canvas.addEventListener('touchstart', (ev) => {
    const t = ev.changedTouches[0];
    touchStart = { x: t.clientX, y: t.clientY, time: Date.now() }; touchId = t.identifier;
  }, { passive: true });
  canvas.addEventListener('touchmove', (ev) => { ev.preventDefault(); }, { passive: false });
  canvas.addEventListener('touchend', (ev) => {
    const t = Array.from(ev.changedTouches).find(tt => tt.identifier === touchId) || ev.changedTouches[0];
    if(!t || !touchStart) return;
    const dx = t.clientX - touchStart.x, dy = t.clientY - touchStart.y;
    if(Math.abs(dx) < swipeThreshold && Math.abs(dy) < swipeThreshold){
      togglePause();
    } else {
      if(Math.abs(dx) > Math.abs(dy)) setDir(dx > 0 ? {x:1,y:0} : {x:-1,y:0});
      else setDir(dy > 0 ? {x:0,y:1} : {x:0,y:-1});
    }
    touchStart = null; touchId = null;
  }, { passive: true });

  // On-screen buttons
  touchPad.addEventListener('pointerdown', (e) => {
    const btn = e.target.closest('button[data-dir]'); if(!btn) return;
    const d = btn.dataset.dir;
    if(d === 'up') setDir({x:0,y:-1});
    if(d === 'down') setDir({x:0,y:1});
    if(d === 'left') setDir({x:-1,y:0});
    if(d === 'right') setDir({x:1,y:0});
    try{ btn.setPointerCapture(e.pointerId); btn.addEventListener('pointerup', ()=>{ try{btn.releasePointerCapture(e.pointerId);}catch(_){} }, { once:true }); }catch(e){}
  });

  // Pause/restart
  function togglePause(){
    if(gameOver) return;
    running = !running; pauseBtn.textContent = running ? 'Duraklat' : 'Devam Et';
    if(running){ lastTick = 0; requestAnimationFrame(loop); updateOverlay(''); }
    else { updateOverlay(`<div class="msg"><h4>Duraklatıldı</h4><p>Devam etmek için 'Devam Et' butonuna veya ekrana dokun.</p></div>`); }
  }
  pauseBtn.addEventListener('click', ()=>{ playClick(); togglePause(); });
  restartBtn.addEventListener('click', ()=>{ playClick(); resetGame(); startLoop(); updateOverlay(''); pauseBtn.textContent = 'Duraklat'; });

  // UI interactions
  themeSelect.addEventListener('change', (e)=>{ applyTheme(e.target.value); playClick(); });
  diffSelect.addEventListener('change', (e)=>{ playClick(); applyDifficulty(e.target.value); });
  wrapToggle.addEventListener('change', (e)=>{ wrapEnabled = e.target.checked; playClick(); });

  // click canvas tap toggles pause (if no overlay)
  canvas.addEventListener('click', (e)=>{ if(overlay.innerHTML.trim()) return; togglePause(); });

  // small helper
  function hexToRgba(hex, alpha){
    if(hex.startsWith('#')) hex = hex.slice(1);
    if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
    const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // Init
  function init(){
    applyTheme(currentTheme);
    resizeCanvas();
    // apply selected difficulty values
    const dif = diffSelect.value || 'normal';
    speed = difficulties[dif].baseSpeed; speedInc = difficulties[dif].speedInc; config.initialLength = difficulties[dif].initialLength;
    wrapEnabled = wrapToggle.checked;
    resetGame();
    requestAnimationFrame(loop);
  }

  // expose for debug
  window.ModernSnake = { resetGame, step, applyTheme, applyDifficulty };

  // Start
  init();

})();
</script>
</body>
</html>
