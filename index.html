<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Modern Snake â€” Deluxe (BaÅŸlat & Ses & Bonus)</title>
<style>
  :root{
    --bg-1: #020617;
    --bg-2: #06152a;
    --accent-a: #00ffb3;
    --accent-b: #ff00fb;
    --muted: rgba(255,255,255,0.85);
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e6eef8;-webkit-font-smoothing:antialiased}
  .wrap{display:flex;flex-direction:column;height:100vh;gap:12px;padding:12px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 8px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent-a),var(--accent-b));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018}
  .stats{display:flex;gap:8px;align-items:center}
  .chip{background:var(--glass);padding:8px 12px;border-radius:12px;font-size:14px;color:var(--muted);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.03)}
  .stage{position:relative;flex:1;display:flex;align-items:center;justify-content:center;min-height:260px}
  canvas{border-radius:14px;box-shadow:0 20px 50px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);touch-action:none;max-width:100%;width:100%;height:auto;max-height: calc(100vh - 240px)}
  .controls-col{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  label{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
  select, button, input[type=checkbox]{font-size:13px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--muted)}
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent-a),var(--accent-b));color:#021018;font-weight:700}
  .overlay-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .msg{pointer-events:auto;background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:18px 22px;border-radius:14px;text-align:center;min-width:240px;border:1px solid rgba(255,255,255,0.03)}
  .touch-pad{position:absolute;right:16px;bottom:16px;display:grid;grid-template-columns:repeat(3,64px);grid-template-rows:repeat(3,64px);gap:10px;z-index:40}
  .touch-pad button{width:64px;height:64px;border-radius:50%;border:none;background: rgba(255,255,255,0.03);color:var(--muted);font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(3,8,20,0.5);backdrop-filter: blur(6px)}
  .touch-pad button:active{transform:scale(0.97)}
  @media (max-width:520px){ .touch-pad{grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px)} .touch-pad button{width:56px;height:56px;font-size:20px} .logo{width:40px;height:40px} }
  .footer-hint{font-size:13px;color:var(--muted);text-align:center;padding:8px 0}
  .small { font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <div style="font-weight:800">Modern Snake</div>
        <div style="font-size:12px;color:var(--muted)">Neon â€¢ Dokunmatik â€¢ WebAudio</div>
      </div>
    </div>

    <div class="stats">
      <div class="chip" id="scoreChip">Puan: 0</div>
      <div class="chip" id="highChip">En YÃ¼ksek: 0</div>
      <button class="btn" id="pauseBtn">Duraklat</button>
      <button class="btn primary" id="restartBtn">Yeniden BaÅŸla</button>
    </div>
  </div>

  <div class="stage">
    <canvas id="game" width="720" height="720" aria-label="Snake oyun alanÄ±"></canvas>

    <div class="overlay-center" id="overlay"></div>

    <div style="position:absolute;right:18px;top:18px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
      <label>
        Tema:
        <select id="themeSelect">
          <option value="night">Gece</option>
          <option value="neon">Neon</option>
          <option value="pastel">Pastel</option>
        </select>
      </label>
      <label>
        Zorluk:
        <select id="diffSelect">
          <option value="easy">Kolay</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Zor</option>
        </select>
      </label>
      <label style="align-items:center">
        <input type="checkbox" id="wrapToggle" checked />&nbsp;Ekran Sarma (Wrap)
      </label>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="startBtn" class="btn primary">BaÅŸlat</button>
        <button id="soundToggle" class="btn">ðŸ”Š Ses AÃ§</button>
        <button id="musicToggle" class="btn">â™ª MÃ¼zik AÃ§</button>
      </div>
    </div>

    <div class="touch-pad" id="touchPad" aria-hidden="false">
      <button class="btn-up" data-dir="up" aria-label="YukarÄ±">â–²</button>
      <button class="btn-left" data-dir="left" aria-label="Sol">â—„</button>
      <button class="btn-down" data-dir="down" aria-label="AÅŸaÄŸÄ±">â–¼</button>
      <button class="btn-right" data-dir="right" aria-label="SaÄŸ">â–º</button>
    </div>
  </div>

  <div class="footer-hint">Swipe veya ok tuÅŸlarÄ± ile yÃ¶nlendir. Ekstra Ã¶ÄŸeler: bonus meyve (+50) ve hÄ±z gÃ¼cÃ¼.</div>
</div>

<script>
(() => {
  // DOM
  const canvas = document.getElementById('game'), ctx = canvas.getContext('2d', { alpha: false });
  const scoreChip = document.getElementById('scoreChip'), highChip = document.getElementById('highChip');
  const overlay = document.getElementById('overlay'), pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn'), touchPad = document.getElementById('touchPad');
  const themeSelect = document.getElementById('themeSelect'), diffSelect = document.getElementById('diffSelect');
  const wrapToggle = document.getElementById('wrapToggle');
  const startBtn = document.getElementById('startBtn'), soundToggle = document.getElementById('soundToggle'), musicToggle = document.getElementById('musicToggle');

  // WebAudio
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  let musicState = { playing:false, masterGain:null, oscs:[], intervalId:null };
  let audioEnabled = true;
  function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); return audioCtx; }

  function playClick(){
    if(!audioEnabled) return;
    try {
      const ctxA = ensureAudio();
      const o = ctxA.createOscillator(); const g = ctxA.createGain();
      o.type = 'square'; o.frequency.value = 900;
      g.gain.value = 0.06;
      o.connect(g); g.connect(ctxA.destination);
      o.start(); o.stop(ctxA.currentTime + 0.05);
    } catch(e) {}
  }
  function playPop(){
    if(!audioEnabled) return;
    try {
      const ctxA = ensureAudio();
      const o = ctxA.createOscillator(); const g = ctxA.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(520, ctxA.currentTime);
      o.frequency.exponentialRampToValueAtTime(260, ctxA.currentTime + 0.14);
      g.gain.setValueAtTime(0.07, ctxA.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ctxA.currentTime + 0.15);
      o.connect(g); g.connect(ctxA.destination);
      o.start(); o.stop(ctxA.currentTime + 0.16);
    } catch(e) {}
  }
  function playFail(){
    if(!audioEnabled) return;
    try {
      const ctxA = ensureAudio();
      const o = ctxA.createOscillator(); const g = ctxA.createGain();
      o.type = 'sawtooth';
      o.frequency.setValueAtTime(160, ctxA.currentTime);
      o.frequency.exponentialRampToValueAtTime(80, ctxA.currentTime + 0.35);
      g.gain.setValueAtTime(0.12, ctxA.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ctxA.currentTime + 0.4);
      o.connect(g); g.connect(ctxA.destination);
      o.start(); o.stop(ctxA.currentTime + 0.45);
    } catch(e) {}
  }

  // simple looping "music" via two oscillators + periodic melody changes
  function startMusic(){
    if(musicState.playing || !audioEnabled) return;
    const ctxA = ensureAudio();
    const master = ctxA.createGain(); master.gain.value = 0.02; master.connect(ctxA.destination);
    const osc1 = ctxA.createOscillator(), g1 = ctxA.createGain();
    const osc2 = ctxA.createOscillator(), g2 = ctxA.createGain();
    osc1.type = 'sine'; osc2.type = 'triangle';
    g1.gain.value = 0.6; g2.gain.value = 0.9;
    osc1.connect(g1); g1.connect(master);
    osc2.connect(g2); g2.connect(master);
    osc1.start(); osc2.start();
    musicState.masterGain = master;
    musicState.oscs = [osc1, osc2];
    let seq = [440, 0, 523, 392, 440, 0, 660, 523];
    let idx = 0;
    musicState.intervalId = setInterval(()=>{
      const f = seq[idx % seq.length] || 220;
      try {
        osc1.frequency.setValueAtTime(f || 220, ctxA.currentTime);
        osc2.frequency.setValueAtTime((f?f*0.5:110), ctxA.currentTime);
      } catch(e){}
      idx++;
    }, 400);
    musicState.playing = true;
  }
  function stopMusic(){
    if(!musicState.playing) return;
    try {
      clearInterval(musicState.intervalId);
      musicState.oscs.forEach(o => { try{o.stop();}catch(e){} });
      try { musicState.masterGain.disconnect(); } catch(e){}
    } catch(e){}
    musicState.playing = false; musicState.oscs = []; musicState.masterGain = null; musicState.intervalId = null;
  }

  // Themes & difficulties
  const baseConfig = { cols:24, rows:24, cellMin:12, initialLength:4 };
  const themes = {
    night: { bg1:'#0f1724', bg2:'#071426', snakeA:'#7b61ff', snakeB:'#00e6a8', apple:['#ff7a64','#ff5040'] },
    neon:  { bg1:'#020617', bg2:'#06152a', snakeA:'#00ffb3', snakeB:'#ff00fb', apple:['#fff000','#ff5500'] },
    pastel:{ bg1:'#f6f8ff', bg2:'#eaf1ff', snakeA:'#9bb4ff', snakeB:'#a6ffc8', apple:['#ff9bb3','#ff6f91'] }
  };
  const difficulties = {
    easy: { baseSpeed:5, speedInc:0.18, initialLength:5 },
    normal: { baseSpeed:8, speedInc:0.3, initialLength:4 },
    hard: { baseSpeed:12, speedInc:0.45, initialLength:3 }
  };

  // State variables
  let config = { ...baseConfig };
  let grid = { ...config, cell: 20, width:0, height:0 };
  let snake = [], dir = {x:1,y:0}, nextDir = null, apple = null, bonus = null, power = null;
  let score = 0, high = parseInt(localStorage.getItem('modernSnakeHigh') || '0', 10);
  let speed = difficulties.normal.baseSpeed, speedInc = difficulties.normal.speedInc, moveInterval = 1000/speed;
  let running = false, lastTick = 0, accumulator = 0, gameOver = false;
  let deviceRatio = window.devicePixelRatio || 1;
  let currentTheme = 'neon';

  highChip.textContent = 'En YÃ¼ksek: ' + high;
  scoreChip.textContent = 'Puan: 0';
  soundToggle.textContent = audioEnabled ? 'ðŸ”Š Ses AÃ§' : 'ðŸ”‡ Ses KapalÄ±';
  musicToggle.textContent = musicState.playing ? 'â™ª MÃ¼zik Kapat' : 'â™ª MÃ¼zik AÃ§';

  function resizeCanvas(){
    const availW = Math.max(300, window.innerWidth - 48);
    const availH = Math.max(300, window.innerHeight - 260);
    const useW = Math.min(availW, Math.max(availH, availW));
    const useH = Math.min(availH, useW * 1.2);
    let size = Math.min(useW, useH);
    size = Math.max(280, Math.min(900, Math.floor(size)));
    const cell = Math.floor(size / grid.cols);
    grid.cell = Math.max(cell, config.cellMin);
    grid.width = grid.cell * grid.cols; grid.height = grid.cell * grid.rows;
    deviceRatio = window.devicePixelRatio || 1;
    canvas.style.width = grid.width + 'px'; canvas.style.height = grid.height + 'px';
    canvas.width = Math.floor(grid.width * deviceRatio); canvas.height = Math.floor(grid.height * deviceRatio);
    ctx.setTransform(deviceRatio,0,0,deviceRatio,0,0);
    draw();
  }
  window.addEventListener('resize', resizeCanvas);

  function rndInt(min,max){ return Math.floor(Math.random()*(max-min+1)) + min; }

  function placeApple(){
    let attempts = 0;
    while(attempts++ < 2000){
      const x = rndInt(0,grid.cols-1), y = rndInt(0,grid.rows-1);
      if(!snake.some(p=>p.x===x && p.y===y) && (!bonus || bonus.x!==x || bonus.y!==y) && (!power || power.x!==x || power.y!==y)){
        apple = { x, y }; return;
      }
    }
    apple = {x:0,y:0};
  }

  function maybeSpawnBonusOrPower(){
    // 20% chance spawn bonus (+50); 10% chance spawn power (slow/boost)
    if(bonus || power) return;
    const r = Math.random();
    if(r < 0.20){
      // bonus
      let attempts=0;
      while(attempts++<1000){
        const x=rndInt(0,grid.cols-1), y=rndInt(0,grid.rows-1);
        if(!snake.some(p=>p.x===x&&p.y===y) && !(apple.x===x&&apple.y===y)){ bonus={x,y,ttl:10000}; setTimeout(()=>{ if(bonus && bonus.x===x && bonus.y===y) bonus=null; },10000); break; }
      }
    } else if(r < 0.30){
      // power: type 'slow' or 'fast'
      const type = Math.random() < 0.5 ? 'slow' : 'fast';
      let attempts=0;
      while(attempts++<1000){
        const x=rndInt(0,grid.cols-1), y=rndInt(0,grid.rows-1);
        if(!snake.some(p=>p.x===x&&p.y===y) && !(apple.x===x&&apple.y===y)){ power={x,y,type,ttl:12000}; setTimeout(()=>{ if(power && power.x===x && power.y===y) power=null; },12000); break; }
      }
    }
  }

  function applyTheme(name){
    currentTheme = name;
    const t = themes[name];
    document.documentElement.style.setProperty('--bg-1', t.bg1);
    document.documentElement.style.setProperty('--bg-2', t.bg2);
    document.documentElement.style.setProperty('--accent-a', t.snakeA);
    document.documentElement.style.setProperty('--accent-b', t.snakeB);
    draw();
  }

  function resetGame(){
    snake = [];
    const sx = Math.floor(grid.cols/2), sy = Math.floor(grid.rows/2);
    const d = difficulties[diffSelect.value] || difficulties.normal;
    speed = d.baseSpeed; speedInc = d.speedInc;
    for(let i=0;i<d.initialLength;i++) snake.push({x:sx-i, y:sy});
    dir = {x:1,y:0}; nextDir = null; score = 0; moveInterval = 1000/speed; running = false; gameOver=false; bonus = null; power=null;
    scoreChip.textContent = 'Puan: ' + score;
    placeApple();
    updateOverlay('');
  }

  // draw
  function drawGrid(){
    ctx.clearRect(0,0,grid.width,grid.height);
    const t = themes[currentTheme];
    const g = ctx.createLinearGradient(0,0,0,grid.height);
    g.addColorStop(0, t.bg1); g.addColorStop(1, t.bg2);
    ctx.fillStyle = g; roundRect(ctx,0,0,grid.width,grid.height,12); ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.02)'; ctx.lineWidth=1;
    for(let x=0;x<=grid.width;x+=grid.cell){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,grid.height); ctx.stroke(); }
    for(let y=0;y<=grid.height;y+=grid.cell){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(grid.width,y+0.5); ctx.stroke(); }
  }
  function drawApple(){
    if(!apple) return;
    const s = grid.cell; const x = apple.x*s, y = apple.y*s; const cx=x+s/2, cy=y+s/2, r=s*0.36;
    const [c1,c2] = themes[currentTheme].apple;
    const g = ctx.createRadialGradient(cx,cy,r*0.1,cx,cy,r*1.2); g.addColorStop(0,c1); g.addColorStop(1,hexToRgba(c2,0.12));
    ctx.fillStyle = g; circle(ctx,cx,cy,r); ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; circle(ctx,cx-r*0.35,cy-r*0.35,r*0.12); ctx.fill();
  }
  function drawBonus(){
    if(!bonus) return;
    const s=grid.cell; const x=bonus.x*s, y=bonus.y*s, cx=x+s/2, cy=y+s/2;
    // diamond
    ctx.fillStyle = 'rgba(255,215,64,0.98)';
    ctx.beginPath();
    ctx.moveTo(cx, cy - s*0.28);
    ctx.lineTo(cx + s*0.22, cy);
    ctx.lineTo(cx, cy + s*0.28);
    ctx.lineTo(cx - s*0.22, cy);
    ctx.closePath(); ctx.fill();
  }
  function drawPower(){
    if(!power) return;
    const s=grid.cell; const x=power.x*s, y=power.y*s, cx=x+s/2, cy=y+s/2;
    ctx.fillStyle = power.type === 'slow' ? 'rgba(80,160,255,0.95)' : 'rgba(255,80,120,0.95)';
    ctx.beginPath(); ctx.moveTo(cx - s*0.2, cy - s*0.15); ctx.lineTo(cx + s*0.2, cy - s*0.15); ctx.lineTo(cx + s*0.1, cy + s*0.25); ctx.lineTo(cx - s*0.1, cy + s*0.25); ctx.closePath(); ctx.fill();
  }
  function drawSnake(){
    if(!snake.length) return;
    const s = grid.cell;
    for(let i=snake.length-1;i>=0;i--){
      const p = snake[i]; const px=p.x*s, py=p.y*s;
      const t = 1 - (i / snake.length);
      const color = lerpColor(themes[currentTheme].snakeA, themes[currentTheme].snakeB, t);
      roundRect(ctx, px+2, py+2, s-4, s-4, 6);
      ctx.fillStyle = color; ctx.fill();
    }
    // head sheen
    const head = snake[0];
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    circle(ctx, head.x*grid.cell + grid.cell/2 - grid.cell*0.08, head.y*grid.cell + grid.cell/2 - grid.cell*0.18, grid.cell*0.12); ctx.fill();
  }
  function drawGlow(){ const g = ctx.createRadialGradient(0,0,20, grid.width*0.6, grid.height*0.4, Math.max(grid.width,grid.height)); g.addColorStop(0, hexToRgba(themes[currentTheme].snakeB, 0.06)); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,0,grid.width,grid.height); }
  function draw(){ drawGrid(); drawApple(); drawBonus(); drawPower(); drawSnake(); drawGlow(); }

  function roundRect(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }
  function circle(c,x,y,r){ c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.closePath(); }
  function lerpColor(a,b,t){ const pa=parseInt(a.slice(1),16), pb=parseInt(b.slice(1),16); const ar=(pa>>16)&255,ag=(pa>>8)&255,ab=pa&255; const br=(pb>>16)&255,bg=(pb>>8)&255,bb=pb&255; const rr=Math.round(ar+(br-ar)*t), rg=Math.round(ag+(bg-ag)*t), rb=Math.round(ab+(bb-ab)*t); return `rgb(${rr},${rg},${rb})`; }
  function hexToRgba(hex,a){ if(hex.startsWith('#')) hex=hex.slice(1); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

  // game logic
  function step(){
    if(gameOver || !running) return;
    if(nextDir){ if(!(nextDir.x === -dir.x && nextDir.y === -dir.y)) dir = nextDir; nextDir = null; }
    let nx = snake[0].x + dir.x, ny = snake[0].y + dir.y;
    if(wrapToggle.checked){
      if(nx < 0) nx = grid.cols - 1;
      if(nx >= grid.cols) nx = 0;
      if(ny < 0) ny = grid.rows - 1;
      if(ny >= grid.rows) ny = 0;
    } else {
      if(nx < 0 || nx >= grid.cols || ny < 0 || ny >= grid.rows) return doGameOver();
    }
    if(snake.some(s => s.x===nx && s.y===ny)) return doGameOver();
    snake.unshift({x:nx,y:ny});
    // apple
    if(apple && nx===apple.x && ny===apple.y){
      score += 10; playPop();
      scoreChip.textContent = 'Puan: ' + score;
      // speed increase
      speed = Math.min(60, speed + speedInc);
      moveInterval = 1000 / speed;
      placeApple();
      maybeSpawnBonusOrPower();
    } else {
      snake.pop();
    }
    // bonus
    if(bonus && nx===bonus.x && ny===bonus.y){
      score += 50; bonus = null; playPop(); scoreChip.textContent = 'Puan: ' + score;
      // small speed change: slow slightly (reward)
      speed = Math.max(3, speed - 1);
      moveInterval = 1000 / speed;
    }
    // power
    if(power && nx===power.x && ny===power.y){
      const t = power.type;
      power = null;
      if(t==='slow'){ // slow effect: decrease speed temporarily
        const old = speed; speed = Math.max(3, speed * 0.6); moveInterval = 1000/speed;
        setTimeout(()=>{ speed = old; moveInterval = 1000/speed; }, 6000);
      } else {
        const old = speed; speed = Math.min(80, speed * 1.4); moveInterval = 1000/speed;
        setTimeout(()=>{ speed = old; moveInterval = 1000/speed; }, 6000);
      }
      playClick();
    }
  }

  function doGameOver(){
    gameOver = true; running = false; playFail();
    updateOverlay(`<div class="msg"><h3>Oyun Bitti</h3><p>PuanÄ±n: ${score}</p><div style="display:flex;gap:8px;justify-content:center;margin-top:10px;"><button class="btn primary" id="overlayRestart">Tekrar Oyna</button></div></div>`);
    setTimeout(()=>{ const r=document.getElementById('overlayRestart'); if(r) r.addEventListener('click', ()=>{ resetGame(); startLoop(); updateOverlay(''); playClick(); }); },10);
  }

  function updateOverlay(html){ overlay.innerHTML = html || ''; }

  // main loop (rAF + accumulator)
  function loop(ts){
    if(!lastTick) lastTick = ts;
    const delta = ts - lastTick; lastTick = ts; accumulator += delta;
    while(accumulator >= moveInterval){ step(); accumulator -= moveInterval; }
    draw();
    if(!gameOver && running) requestAnimationFrame(loop);
  }
  function startLoop(){ lastTick = 0; accumulator = 0; if(!gameOver) requestAnimationFrame(loop); running = true; }

  // Input: keyboard
  window.addEventListener('keydown', e=>{
    if(gameOver) return;
    if(e.repeat) return;
    if(e.key === 'ArrowUp' || e.key === 'w') { nextDir = {x:0,y:-1}; playClick(); }
    if(e.key === 'ArrowDown' || e.key === 's') { nextDir = {x:0,y:1}; playClick(); }
    if(e.key === 'ArrowLeft' || e.key === 'a') { nextDir = {x:-1,y:0}; playClick(); }
    if(e.key === 'ArrowRight' || e.key === 'd') { nextDir = {x:1,y:0}; playClick(); }
    if(e.key === ' ' ) togglePause();
  });

  function setDir(d){ if(d.x === -dir.x && d.y === -dir.y) return; nextDir = d; }

  // Touch swipe detection
  let touchStart = null, touchId = null;
  const swipeThreshold = 20;
  canvas.addEventListener('touchstart', ev=>{ const t = ev.changedTouches[0]; touchStart = {x:t.clientX,y:t.clientY,time:Date.now()}; touchId = t.identifier; }, { passive:true });
  canvas.addEventListener('touchmove', ev=>{ ev.preventDefault(); }, { passive:false });
  canvas.addEventListener('touchend', ev=>{ const t = Array.from(ev.changedTouches).find(tt=>tt.identifier===touchId) || ev.changedTouches[0]; if(!t||!touchStart) return; const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y; if(Math.abs(dx)<swipeThreshold && Math.abs(dy)<swipeThreshold){ togglePause(); } else { if(Math.abs(dx)>Math.abs(dy)) setDir(dx>0?{x:1,y:0}:{x:-1,y:0}); else setDir(dy>0?{x:0,y:1}:{x:0,y:-1}); } touchStart=null; touchId=null; }, { passive:true });

  // on-screen buttons
  touchPad.addEventListener('pointerdown', e=>{
    const btn = e.target.closest('button[data-dir]'); if(!btn) return;
    const d = btn.dataset.dir; if(d==='up') setDir({x:0,y:-1}); if(d==='down') setDir({x:0,y:1}); if(d==='left') setDir({x:-1,y:0}); if(d==='right') setDir({x:1,y:0});
    try{ btn.setPointerCapture(e.pointerId); btn.addEventListener('pointerup', ()=>{ try{btn.releasePointerCapture(e.pointerId);}catch(_){} }, { once:true }); }catch(e){}
    playClick();
  });

  // pause / restart
  function togglePause(){ if(gameOver) return; running = !running; pauseBtn.textContent = running ? 'Duraklat' : 'Devam Et'; if(running){ lastTick = 0; requestAnimationFrame(loop); updateOverlay(''); } else { updateOverlay(`<div class="msg"><h4>DuraklatÄ±ldÄ±</h4><p>Devam etmek iÃ§in 'Devam Et' butonuna veya ekrana dokun.</p></div>`); } }
  pauseBtn.addEventListener('click', ()=>{ playClick(); togglePause(); });
  restartBtn.addEventListener('click', ()=>{ playClick(); resetGame(); startLoop(); updateOverlay(''); pauseBtn.textContent='Duraklat'; });

  // UI interactions
  themeSelect.addEventListener('change', (e)=>{ playClick(); applyTheme(e.target.value); });
  diffSelect.addEventListener('change', (e)=>{ playClick(); resetGame(); });
  wrapToggle.addEventListener('change', (e)=>{ playClick(); });

  // Start / Sound / Music buttons
  startBtn.addEventListener('click', ()=>{
    // resume audio context on first user action
    try{ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); } catch(e){}
    playClick();
    resetGame();
    startLoop();
    pauseBtn.textContent = 'Duraklat';
    // optional: start music if user wants
    if(musicState.playing === false && musicToggle.dataset.wanted === 'true'){
      startMusic(); musicToggle.textContent = 'â™ª MÃ¼zik Kapat';
    }
  });

  soundToggle.addEventListener('click', ()=>{
    audioEnabled = !audioEnabled;
    soundToggle.textContent = audioEnabled ? 'ðŸ”Š Ses AÃ§' : 'ðŸ”‡ Ses KapalÄ±';
    if(!audioEnabled){ stopMusic(); musicToggle.textContent = 'â™ª MÃ¼zik AÃ§'; }
    playClick();
  });

  musicToggle.addEventListener('click', ()=>{
    // toggle requested music state
    if(!audioEnabled){ musicToggle.dataset.wanted = 'true'; alert('Ses kapalÄ± â€” Ã¶nce Ses AÃ§ butonuna basÄ±n.'); return; }
    if(!musicState.playing){ startMusic(); musicToggle.textContent = 'â™ª MÃ¼zik Kapat'; musicToggle.dataset.wanted = 'true'; }
    else { stopMusic(); musicToggle.textContent = 'â™ª MÃ¼zik AÃ§'; musicToggle.dataset.wanted = 'false'; }
    playClick();
  });

  // small helpers
  function updateTheme(t){ applyTheme(t); }
  function resetGameAndStart(){ resetGame(); startLoop(); }

  // init
  function init(){
    resizeCanvas();
    applyTheme(currentTheme);
    resetGame();
    // show initial overlay with quick help
    updateOverlay(`<div class="msg"><h3>Modern Snake</h3><p>BaÅŸlamak iÃ§in <strong>BaÅŸlat</strong> butonuna tÄ±kla.<br/>Mobilde swipe ya da butonlar ile yÃ¶nlendir.</p></div>`);
  }

  window.addEventListener('load', init);
  window.ModernSnake = { resetGame, startMusic, stopMusic };

})();
</script>
</body>
</html>
